<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SOLE JOURNAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .tracking-ultra { letter-spacing: 0.3em; }
        .tracking-mega { letter-spacing: 0.5em; }
        .text-neon { color: #00ff88; }
        .bg-neon { background-color: #00ff88; }
        .border-neon { border-color: #00ff88; }
        .text-micro { font-size: 0.7rem; }
    </style>
</head>
<body class="font-inter bg-gray-50 text-black antialiased">
    <!-- Navigation Container -->
    <div id="navbar-container"></div>

    <!-- Admin Header -->
    <section class="bg-black text-white border-b-4 border-neon">
        <div class="container mx-auto px-4 py-12">
            <div class="flex items-center space-x-4 mb-4">
                <div class="w-12 h-1 bg-neon"></div>
                <span class="text-micro tracking-mega uppercase text-gray-400">ADMIN DASHBOARD</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-black uppercase">ADMIN<br>CONTROL PANEL</h1>
            <p class="text-lg tracking-wider uppercase text-gray-300 mt-4">MANAGE YOUR E-COMMERCE PLATFORM</p>
        </div>
    </section>

    <!-- Admin Navigation -->
    <nav class="bg-white border-b-2 border-black sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 overflow-x-auto">
                <a href="adminDashboard.html" class="border-b-2 border-neon text-neon py-4 px-2 font-bold tracking-wider uppercase text-sm whitespace-nowrap">
                    <i class="fas fa-chart-dashboard mr-2"></i>DASHBOARD
                </a>
                <a href="adminProducts.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-shoe-prints mr-2"></i>PRODUCTS
                </a>
                <a href="adminOrders.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-receipt mr-2"></i>ORDERS
                </a>
                <a href="adminUser.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-users mr-2"></i>USERS
                </a>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Revenue Card -->
                <div class="bg-white border-2 border-black p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-micro tracking-wider uppercase text-gray-500">TOTAL REVENUE</p>
                            <h3 id="total-revenue" class="text-2xl font-black mt-2">₹0</h3>
                            <p class="text-sm text-neon mt-1">All Time</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Orders Card -->
                <div class="bg-white border-2 border-black p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-micro tracking-wider uppercase text-gray-500">TOTAL ORDERS</p>
                            <h3 id="total-orders" class="text-2xl font-black mt-2">0</h3>
                            <p id="today-orders" class="text-sm text-blue-600 mt-1">0 today</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-shopping-bag text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Users Card -->
                <div class="bg-white border-2 border-black p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-micro tracking-wider uppercase text-gray-500">TOTAL USERS</p>
                            <h3 id="total-users" class="text-2xl font-black mt-2">0</h3>
                            <p class="text-sm text-purple-600 mt-1">Registered</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-users text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Products Card -->
                <div class="bg-white border-2 border-black p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-micro tracking-wider uppercase text-gray-500">TOTAL PRODUCTS</p>
                            <h3 id="total-products" class="text-2xl font-black mt-2">0</h3>
                            <p id="low-stock" class="text-sm text-red-600 mt-1">0 low stock</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-shoe-prints text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Revenue Chart -->
                <div class="lg:col-span-2 bg-white border-2 border-black p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-black uppercase">REVENUE ANALYTICS</h3>
                        <select id="period-select" onchange="loadSalesAnalytics()" class="bg-transparent border-2 border-black px-3 py-1 text-sm tracking-wider uppercase focus:outline-none focus:border-neon">
                            <option value="week">Last Week</option>
                            <option value="month" selected>Last Month</option>
                            <option value="year">Last Year</option>
                        </select>
                    </div>
                    <div class="h-64">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="bg-white border-2 border-black p-6">
                    <h3 class="text-xl font-black uppercase mb-6">RECENT ORDERS</h3>
                    <div id="recent-orders" class="space-y-4">
                        <!-- Recent orders will be loaded here -->
                        <div class="text-center py-8">
                            <i class="fas fa-receipt text-3xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-8 bg-white border-2 border-black p-6">
                <h3 class="text-xl font-black uppercase mb-6">QUICK ACTIONS</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="products.html" class="border-2 border-black p-4 text-center hover:bg-black hover:text-white transition duration-300 group">
                        <i class="fas fa-plus text-2xl mb-2 group-hover:text-white"></i>
                        <p class="font-bold tracking-wider uppercase text-sm">ADD PRODUCT</p>
                    </a>
                    <a href="orders.html" class="border-2 border-black p-4 text-center hover:bg-black hover:text-white transition duration-300 group">
                        <i class="fas fa-eye text-2xl mb-2 group-hover:text-white"></i>
                        <p class="font-bold tracking-wider uppercase text-sm">VIEW ORDERS</p>
                    </a>
                    <a href="users.html" class="border-2 border-black p-4 text-center hover:bg-black hover:text-white transition duration-300 group">
                        <i class="fas fa-user-cog text-2xl mb-2 group-hover:text-white"></i>
                        <p class="font-bold tracking-wider uppercase text-sm">MANAGE USERS</p>
                    </a>
                    <a href="analytics.html" class="border-2 border-black p-4 text-center hover:bg-black hover:text-white transition duration-300 group">
                        <i class="fas fa-chart-bar text-2xl mb-2 group-hover:text-white"></i>
                        <p class="font-bold tracking-wider uppercase text-sm">DETAILED ANALYTICS</p>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-black text-white px-6 py-3 rounded-none border-2 border-neon transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <i id="toast-icon" class="fas fa-info-circle text-neon"></i>
            <span id="toast-message" class="text-sm tracking-wider">This is a toast message</span>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let revenueChart = null;

        // Load components
        async function loadComponents() {
            try {
                const navbarResponse = await fetch('./components/adminNavbar.html');
                document.getElementById('navbar-container').innerHTML = await navbarResponse.text();
                
                const footerResponse = await fetch('../components/footer.html');
                document.getElementById('footer-container').innerHTML = await footerResponse.text();
                
                initializeNavbar();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        function initializeNavbar() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const userDropdownBtn = document.getElementById('user-dropdown-btn');
            const userDropdown = document.getElementById('user-dropdown');

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }

            if (userDropdownBtn && userDropdown) {
                userDropdownBtn.addEventListener('click', () => userDropdown.classList.toggle('hidden'));
                document.addEventListener('click', (e) => {
                    if (!userDropdownBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.add('hidden');
                    }
                });
            }
        }

        // Check admin access
        function checkAdminAccess() {
            const userData = getUserData();
            if (!userData || userData.role !== 'admin') {
                showToast('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return false;
            }
            return true;
        }

        // Load dashboard stats
        async function loadDashboardStats() {
            if (!checkAdminAccess()) return;

            try {
                const response = await apiFetch('/admin/dashboard');
                const stats = response.data.stats;
                const recentOrders = response.data.recentOrders;

                // Update stats cards
                document.getElementById('total-revenue').textContent = `₹${stats.totalRevenue.toLocaleString()}`;
                document.getElementById('total-orders').textContent = stats.totalOrders.toLocaleString();
                document.getElementById('today-orders').textContent = `${stats.todayOrders} today`;
                document.getElementById('total-users').textContent = stats.totalUsers.toLocaleString();
                document.getElementById('total-products').textContent = stats.totalProducts.toLocaleString();
                document.getElementById('low-stock').textContent = `${stats.lowStockProducts} low stock`;

                // Display recent orders
                displayRecentOrders(recentOrders);

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        // Load sales analytics
        async function loadSalesAnalytics() {
            try {
                const period = document.getElementById('period-select').value;
                const response = await apiFetch(`/admin/analytics/sales?period=${period}`);
                const salesData = response.data.salesData;

                renderRevenueChart(salesData, period);
            } catch (error) {
                console.error('Error loading sales analytics:', error);
            }
        }

        // Display recent orders
        function displayRecentOrders(orders) {
            const container = document.getElementById('recent-orders');
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No recent orders</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="flex justify-between items-center border-b border-gray-200 pb-3 last:border-0 last:pb-0">
                    <div>
                        <p class="font-medium text-sm">${order.user?.username || 'Guest'}</p>
                        <p class="text-xs text-gray-500">${order.orderNumber}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm">₹${order.totalAmount.toLocaleString()}</p>
                        <span class="inline-block px-2 py-1 text-xs ${getStatusClass(order.status)}">
                            ${order.status.toUpperCase()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Get status class for styling
        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-blue-100 text-blue-800',
                'shipped': 'bg-orange-100 text-orange-800',
                'delivered': 'bg-green-100 text-green-800',
                'cancelled': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Render revenue chart
        function renderRevenueChart(salesData, period) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Destroy existing chart
            if (revenueChart) {
                revenueChart.destroy();
            }

            const labels = salesData.map(item => item._id);
            const revenue = salesData.map(item => item.revenue);
            const orders = salesData.map(item => item.orders);

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue (₹)',
                            data: revenue,
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Orders',
                            data: orders,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadComponents().then(() => {
                checkAuthStatus();
                updateCartCount();
                
                if (checkAdminAccess()) {
                    loadDashboardStats();
                    loadSalesAnalytics();
                }
            });
        });
    </script>
</body>
</html>