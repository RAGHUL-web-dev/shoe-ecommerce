<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Management - SOLE JOURNAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
        .tracking-ultra { letter-spacing: 0.3em; }
        .tracking-mega { letter-spacing: 0.5em; }
        .text-neon { color: #00ff88; }
        .bg-neon { background-color: #00ff88; }
        .border-neon { border-color: #00ff88; }
        .text-micro { font-size: 0.7rem; }
    </style>
</head>
<body class="font-inter bg-gray-50 text-black antialiased">
    <!-- Navigation Container -->
    <div id="navbar-container"></div>

    <!-- Admin Header -->
    <section class="bg-black text-white border-b-4 border-neon">
        <div class="container mx-auto px-4 py-12">
            <div class="flex items-center space-x-4 mb-4">
                <div class="w-12 h-1 bg-neon"></div>
                <span class="text-micro tracking-mega uppercase text-gray-400">PRODUCTS MANAGEMENT</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-black uppercase">PRODUCTS<br>MANAGEMENT</h1>
            <p class="text-lg tracking-wider uppercase text-gray-300 mt-4">MANAGE YOUR PRODUCT CATALOG</p>
        </div>
    </section>

    <!-- Admin Navigation -->
    <nav class="bg-white border-b-2 border-black sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 overflow-x-auto">
                <a href="adminDashboard.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-chart-dashboard mr-2"></i>DASHBOARD
                </a>
                <a href="adminProducts.html" class="border-b-2 border-neon text-neon py-4 px-2 font-bold tracking-wider uppercase text-sm whitespace-nowrap">
                    <i class="fas fa-shoe-prints mr-2"></i>PRODUCTS
                </a>
                <a href="adminOrders.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-receipt mr-2"></i>ORDERS
                </a>
                <a href="adminUser.html" class="border-b-2 border-transparent hover:border-black text-gray-600 hover:text-black py-4 px-2 font-medium tracking-wider uppercase text-sm whitespace-nowrap transition duration-300">
                    <i class="fas fa-users mr-2"></i>USERS
                </a>
            </div>
        </div>
    </nav>

    <!-- Products Content -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <!-- Products Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 class="text-2xl font-black uppercase">ALL PRODUCTS</h2>
                    <p class="text-gray-600 tracking-wider uppercase text-sm">MANAGE YOUR PRODUCT INVENTORY</p>
                </div>
                <button onclick="openAddProductModal()" class="bg-black text-white px-6 py-3 border-2 border-black hover:bg-white hover:text-black transition duration-300 mt-4 md:mt-0">
                    <i class="fas fa-plus mr-2"></i>ADD NEW PRODUCT
                </button>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white border-2 border-black p-4 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="search-products" placeholder="Search products..." class="w-full px-4 py-2 border-2 border-black focus:outline-none focus:border-neon">
                    </div>
                    <select id="category-filter" class="px-4 py-2 border-2 border-black focus:outline-none focus:border-neon bg-white">
                        <option value="">All Categories</option>
                    </select>
                    <select id="status-filter" class="px-4 py-2 border-2 border-black focus:outline-none focus:border-neon bg-white">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <button onclick="loadProducts()" class="bg-neon text-black px-6 py-2 border-2 border-neon hover:bg-black hover:text-neon transition duration-300 font-bold">
                        <i class="fas fa-filter mr-2"></i>FILTER
                    </button>
                </div>
            </div>

            <!-- Products Table -->
            <div class="bg-white border-2 border-black">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-black">
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">PRODUCT</th>
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">CATEGORY</th>
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">PRICE</th>
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">STOCK</th>
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">STATUS</th>
                                <th class="text-left p-4 font-black tracking-wider uppercase text-sm">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading State -->
                <div id="products-loading" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">Loading products...</p>
                </div>

                <!-- Empty State -->
                <div id="products-empty" class="hidden text-center py-8">
                    <i class="fas fa-shoe-prints text-3xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">No products found</p>
                </div>

                <!-- Pagination -->
                <div id="products-pagination" class="border-t-2 border-black p-4 hidden">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white border-2 border-black w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="border-b-2 border-black p-6">
                <h3 id="product-modal-title" class="text-2xl font-black uppercase">ADD NEW PRODUCT</h3>
            </div>
            
            <form id="product-form" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">PRODUCT NAME</label>
                        <input type="text" name="name" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">CATEGORY</label>
                        <select name="category" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon bg-white">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">PRICE (₹)</label>
                        <input type="number" name="price" step="0.01" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">STOCK QUANTITY</label>
                        <input type="number" name="stock" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">BRAND</label>
                        <input type="text" name="brand" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold tracking-wider uppercase mb-2">STATUS</label>
                        <select name="status" required class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon bg-white">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-bold tracking-wider uppercase mb-2">DESCRIPTION</label>
                    <textarea name="description" rows="4" class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:border-neon"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-bold tracking-wider uppercase mb-2">IMAGES</label>
                    <div class="border-2 border-dashed border-black p-6 text-center">
                        <input type="file" id="product-images" multiple accept="image/*" class="hidden">
                        <div id="image-upload-area" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                            <p class="text-sm tracking-wider uppercase">CLICK TO UPLOAD IMAGES</p>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 5MB</p>
                        </div>
                        <div id="image-preview" class="mt-4 grid grid-cols-4 gap-2 hidden"></div>
                    </div>
                </div>
            </form>
            
            <div class="border-t-2 border-black p-6 flex justify-end space-x-4">
                <button onclick="closeProductModal()" class="px-6 py-3 border-2 border-black hover:bg-black hover:text-white transition duration-300 font-bold">
                    CANCEL
                </button>
                <button onclick="saveProduct()" class="bg-neon text-black px-6 py-3 border-2 border-neon hover:bg-black hover:text-neon transition duration-300 font-bold">
                    SAVE PRODUCT
                </button>
            </div>
        </div>
    </div>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-black text-white px-6 py-3 rounded-none border-2 border-neon transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-2">
            <i id="toast-icon" class="fas fa-info-circle text-neon"></i>
            <span id="toast-message" class="text-sm tracking-wider">This is a toast message</span>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
    let currentEditingProduct = null;
    let selectedImages = [];

    // Load components
    async function loadComponents() {
        try {
            const navbarResponse = await fetch('../components/navbar.html');
            document.getElementById('navbar-container').innerHTML = await navbarResponse.text();
            
            const footerResponse = await fetch('../components/footer.html');
            document.getElementById('footer-container').innerHTML = await footerResponse.text();
            
            initializeNavbar();
        } catch (error) {
            console.error('Error loading components:', error);
        }
    }

    function initializeNavbar() {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const userDropdownBtn = document.getElementById('user-dropdown-btn');
        const userDropdown = document.getElementById('user-dropdown');

        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        }

        if (userDropdownBtn && userDropdown) {
            userDropdownBtn.addEventListener('click', () => userDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!userDropdownBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });
        }
    }

    // Check admin access
    function checkAdminAccess() {
        const userData = getUserData();
        if (!userData || userData.role !== 'admin') {
            showToast('Access denied. Admin privileges required.', 'error');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 2000);
            return false;
        }
        return true;
    }

    // Load products
    async function loadProducts() {
        if (!checkAdminAccess()) return;

        try {
            showLoadingState();
            
            const search = document.getElementById('search-products').value;
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            
            let url = '/admin/products';
            const params = new URLSearchParams();
            
            if (search) params.append('search', search);
            if (category) params.append('category', category);
            if (status) params.append('status', status);
            
            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            console.log('Fetching products from:', url);
            
            const response = await apiFetch(url);
            console.log('Products API Response:', response);
            
            // Handle different response structures
            const products = response.data?.products || response.data || response.products || [];
            console.log('Processed products:', products);
            
            displayProducts(products);
            loadCategories();

        } catch (error) {
            console.error('Error loading products:', error);
            showToast('Error loading products: ' + error.message, 'error');
            showEmptyState();
        }
    }

    // Display products in table
    function displayProducts(products) {
        const tbody = document.getElementById('products-table-body');
        const loading = document.getElementById('products-loading');
        const empty = document.getElementById('products-empty');
        
        loading.classList.add('hidden');
        
        if (!products || products.length === 0) {
            empty.classList.remove('hidden');
            tbody.innerHTML = '';
            return;
        }
        
        empty.classList.add('hidden');
        
        tbody.innerHTML = products.map(product => {
            // Safely handle product data with fallbacks
            const productName = product.name || 'Unnamed Product';
            const productBrand = product.brand || 'No Brand';
            const productCategory = product.category?.name || product.category || 'Uncategorized';
            const productPrice = product.basePrice ? `₹${Number(product.basePrice).toLocaleString()}` : '₹0';
            const productStock = product.count || product.variants.stock || 0;
            const productStatus = product.isActive !== undefined ? (product.isActive ? 'active' : 'inactive') : 'active';
            const productId = product._id || product.id;
            const productImages = product.images || [];
            
            // Handle image URL - could be string or object with url property
            const firstImage = productImages.length > 0 ? 
                (typeof productImages[0] === 'string' ? productImages[0] : productImages[0].url) : null;

            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="p-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gray-200 flex-shrink-0">
                                ${firstImage ? 
                                    `<img src="${firstImage}" alt="${productName}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full bg-gray-300 flex items-center justify-center">
                                        <i class="fas fa-shoe-prints text-gray-500"></i>
                                    </div>`
                                }
                            </div>
                            <div>
                                <p class="font-bold">${productName}</p>
                                <p class="text-sm text-gray-600">${productBrand}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1 bg-gray-100 text-gray-800 text-sm tracking-wider uppercase">${productCategory}</span>
                    </td>
                    <td class="p-4 font-bold">${productPrice}</td>
                    <td class="p-4">
                        <span class="${productStock < 10 ? 'text-red-600 font-bold' : 'text-gray-800'}">
                            ${productStock}
                        </span>
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1 ${productStatus === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-sm tracking-wider uppercase">
                            ${productStatus}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="flex space-x-2">
                            <button onclick="editProduct('${productId}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct('${productId}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="viewProduct('${productId}')" class="text-green-600 hover:text-green-800">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Show loading state
    function showLoadingState() {
        document.getElementById('products-loading').classList.remove('hidden');
        document.getElementById('products-empty').classList.add('hidden');
        document.getElementById('products-table-body').innerHTML = '';
    }

    // Show empty state
    function showEmptyState() {
        document.getElementById('products-loading').classList.add('hidden');
        document.getElementById('products-empty').classList.remove('hidden');
        document.getElementById('products-table-body').innerHTML = '';
    }

    // Load categories for filters
    async function loadCategories() {
        try {
            console.log('Loading categories...');
            const response = await apiFetch('/admin/categories');
            console.log('Categories response:', response);
            
            const categories = response.data?.categories || response.data || [];
            console.log('Processed categories:', categories);
            
            const categoryFilter = document.getElementById('category-filter');
            const categorySelect = document.querySelector('select[name="category"]');
            
            const categoryOptions = categories.map(cat => {
                const categoryName = cat.name || cat;
                const categoryValue = cat._id || cat.name || cat;
                return `<option value="${categoryValue}">${categoryName}</option>`;
            }).join('');
            
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + categoryOptions;
            categorySelect.innerHTML = '<option value="">Select Category</option>' + categoryOptions;
            
        } catch (error) {
            console.error('Error loading categories:', error);
            // Don't show toast for categories error as it's not critical
            // Set default categories for testing
            const defaultCategories = ['Sneakers', 'Boots', 'Sandals', 'Formal', 'Sports'];
            const categoryFilter = document.getElementById('category-filter');
            const categorySelect = document.querySelector('select[name="category"]');
            
            const categoryOptions = defaultCategories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
            
            categoryFilter.innerHTML = '<option value="">All Categories</option>' + categoryOptions;
            categorySelect.innerHTML = '<option value="">Select Category</option>' + categoryOptions;
        }
    }

    // Open add product modal
    function openAddProductModal() {
        currentEditingProduct = null;
        document.getElementById('product-modal-title').textContent = 'ADD NEW PRODUCT';
        document.getElementById('product-form').reset();
        selectedImages = [];
        document.getElementById('image-preview').innerHTML = '';
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('product-modal').classList.remove('hidden');
    }

    // Close product modal
    function closeProductModal() {
        document.getElementById('product-modal').classList.add('hidden');
    }

    // Edit product
    async function editProduct(productId) {
        try {
            const response = await apiFetch(`/admin/products/${productId}`);
            const product = response.data?.product || response.data;
            
            currentEditingProduct = productId;
            document.getElementById('product-modal-title').textContent = 'EDIT PRODUCT';
            
            // Fill form with product data
            const form = document.getElementById('product-form');
            form.name.value = product.name || '';
            form.category.value = product.category?._id || product.category || '';
            form.price.value = product.price || '';
            form.stock.value = product.stock || product.quantity || '';
            form.brand.value = product.brand || '';
            form.status.value = product.isActive !== undefined ? (product.isActive ? 'active' : 'inactive') : 'active';
            form.description.value = product.description || '';
            
            // Handle images
            selectedImages = product.images || [];
            updateImagePreview();
            
            document.getElementById('product-modal').classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading product:', error);
            showToast('Error loading product: ' + error.message, 'error');
        }
    }

    // Save product
    async function saveProduct() {
        try {
            const form = document.getElementById('product-form');
            const formData = new FormData();
            
            // Add basic fields
            formData.append('name', form.name.value);
            formData.append('category', form.category.value);
            formData.append('price', form.price.value);
            formData.append('stock', form.stock.value);
            formData.append('brand', form.brand.value);
            formData.append('isActive', form.status.value === 'active');
            formData.append('description', form.description.value);

            // Add images to form data
            selectedImages.forEach((image, index) => {
                if (image instanceof File) {
                    formData.append('images', image);
                } else {
                    // For existing images, we might need to handle them differently
                    formData.append('existingImages', JSON.stringify(selectedImages));
                    return;
                }
            });

            let response;
            if (currentEditingProduct) {
                response = await apiFetch(`/api/admin/products/${currentEditingProduct}`, {
                    method: 'PATCH',
                    body: formData
                });
                showToast('Product updated successfully', 'success');
            } else {
                response = await apiFetch('/api/admin/products', {
                    method: 'POST',
                    body: formData
                });
                showToast('Product created successfully', 'success');
            }

            closeProductModal();
            loadProducts();
            
        } catch (error) {
            console.error('Error saving product:', error);
            showToast('Error saving product: ' + error.message, 'error');
        }
    }

    // Delete product
    async function deleteProduct(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        
        try {
            await apiFetch(`/api/admin/products/${productId}`, {
                method: 'DELETE'
            });
            
            showToast('Product deleted successfully', 'success');
            loadProducts();
            
        } catch (error) {
            console.error('Error deleting product:', error);
            showToast('Error deleting product: ' + error.message, 'error');
        }
    }

    // View product details
    function viewProduct(productId) {
        window.open(`../product.html?id=${productId}`, '_blank');
    }

    // Initialize image upload
    function initializeImageUpload() {
        const uploadArea = document.getElementById('image-upload-area');
        const fileInput = document.getElementById('product-images');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            selectedImages.push(...files);
            updateImagePreview();
        });
    }

    // Update image preview
    function updateImagePreview() {
        const preview = document.getElementById('image-preview');
        
        if (selectedImages.length === 0) {
            preview.classList.add('hidden');
            return;
        }
        
        preview.classList.remove('hidden');
        preview.innerHTML = selectedImages.map((image, index) => {
            const src = image instanceof File ? URL.createObjectURL(image) : image;
            return `
                <div class="relative">
                    <img src="${src}" alt="Preview" class="w-full h-20 object-cover border-2 border-black">
                    <button type="button" onclick="removeImage(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 flex items-center justify-center text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    // Remove image
    function removeImage(index) {
        selectedImages.splice(index, 1);
        updateImagePreview();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadComponents().then(() => {
            checkAuthStatus();
            updateCartCount();
            
            if (checkAdminAccess()) {
                loadProducts();
                initializeImageUpload();
                
                // Add event listeners for search and filters
                document.getElementById('search-products').addEventListener('input', debounce(loadProducts, 500));
                document.getElementById('category-filter').addEventListener('change', loadProducts);
                document.getElementById('status-filter').addEventListener('change', loadProducts);
            }
        });
    });

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Debug function - call this in browser console
    async function debugProducts() {
        try {
            const response = await apiFetch('/api/admin/products');
            console.log('Full API Response:', response);
            console.log('Response data:', response.data);
            if (response.data && response.data.products) {
                console.log('Products array:', response.data.products);
                if (response.data.products.length > 0) {
                    console.log('First product:', response.data.products[0]);
                    console.log('First product keys:', Object.keys(response.data.products[0]));
                }
            }
        } catch (error) {
            console.error('Debug error:', error);
        }
    }
</script>       
</body>
</html>